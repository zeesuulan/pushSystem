"use strict";angular.module("CS").controller("c_index",function($scope){$scope.showLogin=!1,$.get("api/checkLogin.php",function(data){0==data.no&&(window.location.hash="/menu"),$scope.$apply(function(){$scope.showLogin=!0})},"json"),$scope.submit=function(ele){$.post("api/login.php",$(ele.target).serialize(),function(data){0==data.no?($.cookie("username",data.data.username),window.location.hash="/menu"):alert(data.data)},"json")}}),angular.module("CS").controller("c_menu",function($scope){$.get("api/checkLogin.php",function(data){0==data.no&&$scope.$apply(function(){$scope.isAdmin=1==data.data.group,$scope.isAdmin||(window.location.hash="/menu")})},"json")}),angular.module("CS").controller("c_pushsystem",function($scope,$upload){function getFlashGame(){$.get("api/getFlashGames.php",{repush:0},function(data){return 0==data.no?void $scope.$apply(function(){$scope.games=data.data.games,$scope.priority_tasks=data.data.priority_tasks,$scope.nomarl_tasks=data.data.nomarl_tasks,$scope.countrys=data.data.countrys}):void 0},"json")}$scope.games=[],$scope.pushsystemcls="active",$scope.lan=window.LAN,$scope.imagepath="",$scope.c_all=!1,$scope.l_all=!1,$scope.isAdmin=!0,$.get("api/checkLogin.php",function(data){return 0!=data.no?void(window.location.hash="/index"):void($scope.isAdmin=1==data.data.group)},"json"),$scope.$watch("data.date",function(newValue){$scope.dateformat=moment(newValue).format("YYYY-MM-DD HH:mm"),$scope.repush=!1}),$scope.repushChanged=function(){$scope.repush&&($scope.dateformat="")},$scope.filepathChanged=function(){$scope.filepath.indexOf(".apk")<0&&$scope.filepath.indexOf(".ipa")<0&&(alert("上传文件格式不对"),$scope.filepath="")},$scope.c_all_click=function(){angular.forEach($scope.countrys,function(c){c.s=!$scope.c_all})},$scope.l_all_click=function(){angular.forEach($scope.lan,function(l){l.s=!$scope.l_all})},$scope.search=function(evt){$.post("api/searchTask.php",{key:$(evt.target).val()},function(data){0==data.no?$scope.tasks=data.data.tasks:alert(data.data)},"json")},$scope.del=function(evt){window.confirm("确定删除任务？")&&$.post("api/deleteTask.php",{id:$(evt.target).attr("tid")},function(data){0==data.no?getFlashGame():alert(data.data)},"json")};var canpush=!0;$scope.pushTask=function(evt){var target=$(evt.target),tid=target.attr("tid"),title=target.attr("title");return canpush?void(window.confirm("确定推送任务『"+title+"』 ？")&&(canpush=!1,$.post("api/pushTask.php",{task_id:tid},function(data){if("object"!=typeof data.data.result)alert(data.data.result);else{var res=data.data.result,successNumber=res.success,totalNumber=res.total;alert("共向设备推送消息"+totalNumber+"条，成功推送"+successNumber+"条，失败"+(totalNumber-successNumber)+"条!"),getFlashGame()}canpush=!0},"json"))):void alert("有任务正在推送中，稍后再操作")},$scope.onFileSelect=function($files,$type){var file=$files[0];-1==file.type.indexOf("image")&&($scope.error="image extension not allowed, please choose a JPEG or PNG file."),file.size>2097152&&($scope.error="File size cannot exceed 2 MB"),$scope.upload=$upload.upload({url:"api/doUpload.php",data:{fname:$scope.fname,type:$type},file:file}).success(function(data){0==data.no?"image"==$type?$scope.imagepath=data.data.filepath:$scope.filepath=data.data.filepath:alert(data.data)})},$("#addTask").on("submit",function(){$.post("api/addTask.php",$(this).serialize(),function(data){0==data.no&&(getFlashGame(),$("#addTaskDialog").modal("hide").find("input").val("").find("textarea").val("").find("img").attr("src",""),$scope.imagepath="",$scope.filepath=""),alert(data.data)},"json")}),$("#task-table").on("mouseenter","img",function(){$(this).stop().animate({width:"150px",height:"150px"})}).on("mouseleave","img",function(){$(this).stop().animate({width:"30px",height:"30px"})}).on("mouseover","span[data-toggle=tooltip]",function(){$(this).tooltip("show")}),getFlashGame()}).controller("c_pushpool",function($scope){function getTasks(){$.get("api/getRepushTask.php",function(data){0==data.no&&$scope.$apply(function(){$scope.repush_tasks=data.data.repush_tasks})},"json")}$scope.pushpoolcls="active",getTasks(),$("#single-log-table").on("mouseenter","img",function(){$(this).stop().animate({width:"150px",height:"150px"})}).on("mouseleave","img",function(){$(this).stop().animate({width:"30px",height:"30px"})}).on("mouseover","span[data-toggle=tooltip]",function(){$(this).tooltip("show")}),$scope.$watch("data.date",function(newValue){$scope.dateformat=moment(newValue).format("HH")}),$scope.stick=function(evt){$.post("api/stickTask.php",{id:$(evt.target).attr("tid")},function(data){0==data.no?getTasks():alert(data.data)},"json")},$scope.hour=0,$scope.addHour=function(){$.post("api/setTimeConfig.php",{hour:$scope.hour,type:"add"},function(data){0!=data.no?alert(data.data):$scope.$apply(function(){$scope.hours=data.data.hour.split("")})},"json")},$scope.deleteHour=function(evt){var t=$(evt.target);$.post("api/setTimeConfig.php",{hour:t.attr("hid"),type:"del"},function(data){0!=data.no?alert(data.data):$scope.$apply(function(){$scope.hours=data.data.hour.split("")})},"json")},$.get("api/getTimeConfig.php",function(data){0!=data.no?alert(data.data):$scope.$apply(function(){$scope.hours=data.data.hour.split("")})},"json")}).controller("c_pushlog",function($scope){function getLogs(){$.get("api/getLogs.php",function(data){0==data.no&&$scope.$apply(function(){$scope.singleLogs=data.data.singleLogs,$scope.repushlogs=data.data.repushlogs})},"json")}$scope.pushlogcls="active",getLogs()}).controller("c_dl_log",function($scope){function getLogs(){$.get("api/getDownloadLogs.php",function(data){0==data.no&&$scope.$apply(function(){$scope.dl_logs=data.data.download_log,$scope.total=data.data.total})},"json")}$scope.dl_log="active",getLogs()}),angular.module("CS").controller("c_user",function($scope){function getUsers(){$.get("api/getUsers.php",function(data){0==data.no&&$scope.$apply(function(){$scope.users=data.data.users})},"json")}$.get("api/checkLogin.php",function(data){0==data.no&&$scope.$apply(function(){$scope.isAdmin=1==data.data.group,$scope.isAdmin||(window.location.hash="/menu")})},"json"),$scope.submit=function(evt){evt.target&&$.post("api/adduser.php",$(evt.target).serialize(),function(data){0==data.no?($(evt.target).find("input").val(""),getUsers()):alert(data.data)},"json")},$scope.delUser=function(evt){var btn=$(evt.target);window.confirm("确认要删除?")&&$.post("api/del.php",{type:"user",id:btn.attr("uid")},function(data){0==data.no?getUsers():alert(data.data)},"json")},getUsers()});